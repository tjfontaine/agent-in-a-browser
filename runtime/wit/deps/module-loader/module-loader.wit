package mcp:module-loader@0.1.0;

/// Interface for lazy-loading WASM command modules
/// Provides subprocess-like interface for modules loaded on-demand
interface loader {
  /// Execution environment containing working directory and env vars
  record exec-env {
    cwd: string,
    vars: list<tuple<string, string>>,
  }

  /// A pollable resource (from wasi:io/poll)
  use wasi:io/poll@0.2.4.{pollable};

  /// A handle to a lazy-loaded process
  resource lazy-process {
    /// Get a pollable that resolves when the process has output ready
    get-ready-pollable: func() -> pollable;
    
    /// Check if output is ready without blocking
    is-ready: func() -> bool;
    
    /// Write data to the process stdin
    write-stdin: func(data: list<u8>) -> u64;
    
    /// Close the stdin stream
    close-stdin: func();
    
    /// Read from stdout (up to max-bytes)
    read-stdout: func(max-bytes: u64) -> list<u8>;
    
    /// Read from stderr (up to max-bytes)
    read-stderr: func(max-bytes: u64) -> list<u8>;
    
    /// Try to get exit status without blocking (none if still running)
    try-wait: func() -> option<s32>;
  }

  /// Get the module name for a lazy-loaded command (none if not a lazy command)
  get-lazy-module: func(command: string) -> option<string>;

  /// Spawn a command in a lazy-loaded module
  spawn-lazy-command: func(
    module: string,
    command: string,
    args: list<string>,
    env: exec-env,
  ) -> lazy-process;
}
