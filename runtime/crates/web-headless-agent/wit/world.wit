package agent:headless@0.1.0;

/// Headless agent world - embeddable agent without TUI
world headless-agent {
    // HTTP for LLM API calls
    import wasi:io/error@0.2.4;
    import wasi:io/poll@0.2.4;
    import wasi:io/streams@0.2.4;
    import wasi:http/types@0.2.4;
    import wasi:http/outgoing-handler@0.2.4;
    import wasi:clocks/monotonic-clock@0.2.4;
    import wasi:clocks/wall-clock@0.2.4;
    import wasi:random/insecure-seed@0.2.4;
    
    // Agent configuration
    
    // MCP server configuration for remote tool servers
    record mcp-server-config {
        /// URL of the MCP server (e.g., http://localhost:3000)
        url: string,
        /// Optional friendly name for the server (for logging/debugging)
        name: option<string>,
    }
    
    record agent-config {
        provider: string,
        model: string,
        api-key: string,
        base-url: option<string>,
        /// Additional system prompt text to append to the built-in preamble
        /// Mutually exclusive with preamble-override
        preamble: option<string>,
        /// Completely replace the built-in preamble with this text
        /// Mutually exclusive with preamble (if both set, override wins)
        preamble-override: option<string>,
        /// List of MCP servers to connect to
        /// All tools from all servers are aggregated into one tool set
        mcp-servers: option<list<mcp-server-config>>,
        /// Maximum number of tool turns before stopping (default: 25)
        max-turns: option<u32>,
    }
    
    // Message in conversation history
    record message {
        role: message-role,
        content: string,
    }
    
    // Message role
    enum message-role {
        user,
        assistant,
    }
    
    // Tool result data
    record tool-result-data {
        name: string,
        output: string,
        is-error: bool,
    }
    
    // Task lifecycle records for task-based UI
    record task-info {
        id: string,
        name: string,
        description: string,
    }
    
    record task-update-info {
        id: string,
        status: string,
        progress: option<u32>,  // 0-100 percentage
    }
    
    record task-complete-info {
        id: string,
        success: bool,
        output: option<string>,
    }
    
    // Agent event variants
    variant agent-event {
        // Stream events
        stream-start,
        stream-chunk(string),
        stream-complete(string),
        stream-error(string),
        
        // Tool events
        tool-call(string),
        tool-result(tool-result-data),
        
        // Task lifecycle events for task-based UI
        plan-generated(string),           // plan.md content
        task-start(task-info),            // task beginning
        task-update(task-update-info),    // progress update
        task-complete(task-complete-info), // task done
        
        // State
        ready,
    }
    
    // Agent handle (opaque identifier)
    type agent-handle = u32;
    
    // Agent lifecycle
    export create: func(config: agent-config) -> result<agent-handle, string>;
    export destroy: func(handle: agent-handle);
    
    // Streaming API
    export send: func(handle: agent-handle, message: string) -> result<_, string>;
    export poll: func(handle: agent-handle) -> option<agent-event>;
    export cancel: func(handle: agent-handle);
    
    // Plan/Execute workflow
    /// Planning phase - sends user request with "plan" action
    /// Agent should analyze and write /plan.md, then stop and wait for approval
    export plan: func(handle: agent-handle, message: string) -> result<_, string>;
    
    /// Execution phase - sends "execute" action
    /// Agent should read /plan.md and execute all steps
    export execute: func(handle: agent-handle) -> result<_, string>;
    
    // History management
    export get-history: func(handle: agent-handle) -> list<message>;
    export clear-history: func(handle: agent-handle);
}
