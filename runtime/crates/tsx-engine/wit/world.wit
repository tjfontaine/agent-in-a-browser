// tsx-engine module
// Provides tsx/tsc commands with full TypeScript runtime (like ts-node)
// Includes: transpiler (SWC), JS runtime (rquickjs), Node.js shims

package shell:unix@0.1.0;

interface command {
    use wasi:io/streams@0.2.9.{input-stream, output-stream};
    
    record exec-env {
        cwd: string,
        vars: list<tuple<string, string>>,
    }

    run: func(
        name: string,
        args: list<string>,
        env: exec-env,
        stdin: input-stream,
        stdout: output-stream,
        stderr: output-stream,
    ) -> s32;
    
    list-commands: func() -> list<string>;
}

/// Direct TypeScript evaluation interface.
/// Bypasses the stream-based command interface for simpler call/return semantics.
interface eval {
    /// Transpile and execute TypeScript/JavaScript code inline.
    /// Returns ok(stdout + expression result) or err(error message).
    eval: func(code: string, source-name: option<string>) -> result<string, string>;
    
    /// Execute a TypeScript/JavaScript file by path.
    eval-file: func(path: string, args: list<string>) -> result<string, string>;
}

world tsx-engine {
    // WASI core IO
    import wasi:io/error@0.2.9;
    import wasi:io/poll@0.2.9;
    import wasi:io/streams@0.2.9;
    
    // WASI filesystem
    import wasi:filesystem/types@0.2.9;
    import wasi:filesystem/preopens@0.2.9;
    
    // WASI clocks
    import wasi:clocks/wall-clock@0.2.9;
    import wasi:clocks/monotonic-clock@0.2.9;
    
    // WASI random (all interfaces to prevent adapter injection)
    import wasi:random/random@0.2.9;
    import wasi:random/insecure@0.2.9;
    import wasi:random/insecure-seed@0.2.9;
    
    // WASI HTTP for fetch shim
    import wasi:http/types@0.2.9;
    import wasi:http/outgoing-handler@0.2.9;
    
    // WASI CLI (all interfaces to prevent adapter injection)
    import wasi:cli/environment@0.2.9;
    import wasi:cli/exit@0.2.9;
    import wasi:cli/stdin@0.2.9;
    import wasi:cli/stdout@0.2.9;
    import wasi:cli/stderr@0.2.9;
    import wasi:cli/terminal-input@0.2.9;
    import wasi:cli/terminal-output@0.2.9;
    import wasi:cli/terminal-stdin@0.2.9;
    import wasi:cli/terminal-stdout@0.2.9;
    import wasi:cli/terminal-stderr@0.2.9;
    
    // WASI sockets (all interfaces to prevent adapter injection)
    import wasi:sockets/network@0.2.9;
    import wasi:sockets/udp@0.2.9;
    import wasi:sockets/tcp@0.2.9;
    import wasi:sockets/ip-name-lookup@0.2.9;
    
    // iOS bridge (native host APIs)
    import ios:bridge/storage@0.1.0;
    import ios:bridge/device@0.1.0;
    import ios:bridge/render@0.1.0;
    import ios:bridge/permissions@0.1.0;
    // Tier 2 — user consent
    import ios:bridge/contacts@0.1.0;
    import ios:bridge/calendar@0.1.0;
    import ios:bridge/notifications@0.1.0;
    import ios:bridge/clipboard@0.1.0;
    // Tier 3 — system + user consent
    import ios:bridge/location@0.1.0;
    import ios:bridge/health@0.1.0;
    import ios:bridge/keychain@0.1.0;
    import ios:bridge/photos@0.1.0;
    
    export command;
    export eval;
}
