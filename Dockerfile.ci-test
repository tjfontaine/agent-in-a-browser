# This Dockerfile matches GitHub Actions runner environment for local CI testing
FROM ubuntu:24.04

# Install essential packages (matching GitHub Actions ubuntu-24.04)
RUN apt-get update && apt-get install -y \
    curl \
    git \
    ca-certificates \
    gnupg \
    build-essential \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 22.22.0 (matching GitHub Actions)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Install pnpm (latest, will read version from package.json)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Install Rust (matching GitHub Actions stable)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add wasm32-wasip2

# Install Cargo tools
RUN cargo install wit-deps-cli cargo-component wasm-tools --locked

# Install Playwright browser dependencies
RUN npx playwright install-deps chromium

# Set CI environment to use bundled Chromium instead of 'chrome' channel
ENV CI=true

WORKDIR /app

# Copy project files
COPY . .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build WASM components
RUN cd runtime && wit-deps update && \
    cargo component build --release --target wasm32-wasip2 \
    -p ts-runtime-mcp \
    -p tsx-engine \
    -p sqlite-module \
    -p ratatui-demo \
    -p edtui-module \
    -p web-agent-tui \
    -p web-headless-agent

# Transpile WASM modules first (outside of the build script)
# This avoids nested Turbo which ignores TURBO_FORCE
# IMPORTANT: Only delete GENERATED wasm directories, not source files like tui/ and lazy-loading/
ENV TURBO_FORCE=1
RUN rm -rf frontend/src/wasm/mcp-server-jspi frontend/src/wasm/mcp-server-sync \
    frontend/src/wasm/tsx-engine frontend/src/wasm/sqlite-module \
    frontend/src/wasm/web-agent-tui frontend/src/wasm/web-agent-tui-sync \
    frontend/src/wasm/edtui-module frontend/src/wasm/ratatui-demo \
    packages/*/wasm packages/*/wasm-sync packages/*/mcp-server-* && \
    pnpm turbo run transpile transpile:sync --filter=web-agent-frontend...

# Now run the build (which still calls transpile:all, but outputs already exist)
RUN pnpm turbo run build --filter=web-agent-frontend...

# Install Playwright browsers
RUN cd frontend && npx playwright install chromium

# Run E2E tests
CMD ["sh", "-c", "cd frontend && npx playwright test --project=chromium"]
