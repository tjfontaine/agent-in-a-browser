<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Runtime Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        #status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        #status.loading { background: #3a3a5e; }
        #status.ready { background: #1a5e1a; }
        #status.error { background: #5e1a1a; }
        #output {
            background: #0a0a1e;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>WASM Runtime Test Harness</h1>
    <div id="status" class="loading">Initializing WASM sandbox...</div>
    <div id="output"></div>
    
    <script type="module">
        // Import sandbox utilities
        import { initializeSandbox, fetchFromSandbox } from './src/agent/sandbox.ts';
        
        const statusEl = document.getElementById('status');
        const outputEl = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#6bff6b' : '#aaa';
            outputEl.innerHTML += `<span style="color:${color}">[${new Date().toISOString().slice(11,23)}] ${msg}</span>\n`;
            console.log(msg);
        }
        
        let mcpNextId = 1;
        
        // MCP JSON-RPC request helper
        async function mcpRequest(method, params = {}) {
            const request = {
                jsonrpc: '2.0',
                id: mcpNextId++,
                method,
                params
            };
            
            const response = await fetchFromSandbox('/mcp/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });
            
            if (!response.ok) {
                throw new Error(`MCP Request failed: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Call an MCP tool and return structured result
        async function callMcpTool(name, args) {
            const response = await mcpRequest('tools/call', { name, arguments: args });
            
            if (response.error) {
                return { success: false, output: '', error: response.error.message };
            }
            
            const result = response.result;
            const text = result.content?.map(c => c.text).join('\n') || '';
            const isError = result.isError === true;
            
            return {
                success: !isError,
                output: text,
                error: isError ? text : undefined
            };
        }
        
        // Test harness API exposed to Playwright
        window.testHarness = {
            ready: false,
            
            async shellEval(command) {
                try {
                    const result = await callMcpTool('shell_eval', { command });
                    log(`shell_eval: ${command.substring(0, 50)}${command.length > 50 ? '...' : ''} => ${result.success ? 'OK' : 'FAIL'}`, 
                        result.success ? 'success' : 'error');
                    return result;
                } catch (e) {
                    log(`shell_eval error: ${e.message}`, 'error');
                    return { success: false, output: '', error: e.message };
                }
            },
            
            async writeFile(path, content) {
                const result = await callMcpTool('write_file', { path, content });
                if (!result.success) {
                    throw new Error(result.error || 'write_file failed');
                }
                log(`write_file: ${path}`, 'success');
            },
            
            async readFile(path) {
                const result = await callMcpTool('read_file', { path });
                if (!result.success) {
                    throw new Error(result.error || 'read_file failed');
                }
                log(`read_file: ${path}`, 'success');
                return result.output;
            }
        };
        
        // Initialize
        async function init() {
            try {
                log('Initializing sandbox worker...');
                await initializeSandbox();
                log('Sandbox worker ready!', 'success');
                
                log('Initializing MCP...');
                await mcpRequest('initialize', {
                    protocolVersion: '2025-11-25',
                    capabilities: { tools: {} },
                    clientInfo: { name: 'wasm-test-harness', version: '1.0.0' }
                });
                await mcpRequest('initialized', {});
                log('MCP initialized!', 'success');
                
                // Mark harness as ready
                window.testHarness.ready = true;
                statusEl.className = 'ready';
                statusEl.textContent = '✓ WASM Sandbox Ready';
                log('Test harness ready!', 'success');
                
            } catch (e) {
                log(`Initialization failed: ${e.message}`, 'error');
                statusEl.className = 'error';
                statusEl.textContent = `✗ Error: ${e.message}`;
            }
        }
        
        init();
    </script>
</body>
</html>
